-- ========================================
-- –ë–´–°–¢–†–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê –ê–í–¢–û–û–ß–ò–°–¢–ö–ò –ü–†–ò–ï–ú–û–í –ü–ò–©–ò
-- –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 2 —Å—É—Ç–æ–∫
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL –≤ Supabase SQL Editor
-- ========================================

-- 1. –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—á–∏—Å—Ç–∫–∏
CREATE OR REPLACE FUNCTION cleanup_old_food_logs()
RETURNS INTEGER
LANGUAGE plpgsql
AS $$
DECLARE
  deleted_count INTEGER;
BEGIN
  -- –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 2 —Å—É—Ç–æ–∫
  DELETE FROM food_logs
  WHERE logged_at < NOW() - INTERVAL '2 days';
  
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  
  RAISE NOTICE 'üóë –£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π: %', deleted_count;
  
  RETURN deleted_count;
END;
$$;

-- 2. –í–∫–ª—é—á–∞–µ–º pg_cron
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- 3. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–¥–∞—á—É –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
DO $$
BEGIN
  PERFORM cron.unschedule('cleanup-old-food-logs');
EXCEPTION 
  WHEN OTHERS THEN
    NULL;
END $$;

-- 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
SELECT cron.schedule(
  'cleanup-old-food-logs',
  '0 3 * * *',  -- –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 –Ω–æ—á–∏
  'SELECT cleanup_old_food_logs();'
);

-- ========================================
-- –ü–†–û–í–ï–†–ö–ê
-- ========================================

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É
SELECT 
  jobid,
  jobname,
  schedule,
  active
FROM cron.job
WHERE jobname = 'cleanup-old-food-logs';

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ
SELECT 
  COUNT(*) as "–ó–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ä—à–µ 2 –¥–Ω–µ–π",
  MIN(logged_at) as "–°–∞–º–∞—è —Å—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å"
FROM food_logs
WHERE logged_at < NOW() - INTERVAL '2 days';

-- ========================================
-- –†–£–ß–ù–û–ô –ó–ê–ü–£–°–ö (–¥–ª—è —Ç–µ—Å—Ç–∞)
-- ========================================

-- –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –≤—Ä—É—á–Ω—É—é:
-- SELECT cleanup_old_food_logs();

-- ========================================
-- –ì–û–¢–û–í–û! ‚úÖ
-- ========================================
-- –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 –Ω–æ—á–∏ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å—Å—è

