# üß† –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –ø–æ–º–Ω–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤–µ—Å—Ç–∏ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥, –∞ –Ω–µ –Ω–∞—á–∏–Ω–∞—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑ —Å –Ω—É–ª—è.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ù–æ–≤–æ–µ –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü–µ `users`:

```sql
conversation_context JSONB DEFAULT '[]'::jsonb
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**
```json
[
  {
    "role": "user",
    "content": "–ù–µ –º–Ω–æ–≥–æ–≤–∞—Ç–æ –ª–∏ —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤ 317 –≥—Ä–∞–º–º –≤ —Å—É—Ç–∫–∏?",
    "timestamp": "2025-10-22T14:37:00.000Z"
  },
  {
    "role": "assistant", 
    "content": "–í—ã –ø—Ä–∞–≤—ã, 317–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–Ω–æ–≥–æ –¥–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è...",
    "timestamp": "2025-10-22T14:37:05.000Z"
  }
]
```

## –§—É–Ω–∫—Ü–∏–∏

### `addToContext(userId, role, content)`

–î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `userId` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `role` - –†–æ–ª—å (`'user'` –∏–ª–∏ `'assistant'`)
- `content` - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç timestamp

### `getContext(userId)`

–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –ú–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

### `clearContext(userId)`

–û—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ `getSmartAdvice`:

```
–ö–û–ù–¢–ï–ö–°–¢ –†–ê–ó–ì–û–í–û–†–ê (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è):
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ù–µ –º–Ω–æ–≥–æ–≤–∞—Ç–æ –ª–∏ —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤ 317 –≥—Ä–∞–º–º –≤ —Å—É—Ç–∫–∏?
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: –í—ã –ø—Ä–∞–≤—ã, 317–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–Ω–æ–≥–æ –¥–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è...

–í–ê–ñ–ù–û: 
- –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—Ä–∏—Ç–∏–∫—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ —Ü–µ–ª–∏ - —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π –∏—Ö
```

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

### `/clear` - –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```
üßπ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –æ—á–∏—â–µ–Ω! –¢–µ–ø–µ—Ä—å –±–æ—Ç –Ω–∞—á–Ω–µ—Ç –¥–∏–∞–ª–æ–≥ —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞.
```

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –î–æ (–±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ù–µ –º–Ω–æ–≥–æ–≤–∞—Ç–æ –ª–∏ —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤ 317 –≥—Ä–∞–º–º –≤ —Å—É—Ç–∫–∏?
–ë–æ—Ç: –ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º —Ç–≤–æ–π —Ä–∞—Ü–∏–æ–Ω... [–Ω–∞—á–∏–Ω–∞–µ—Ç —Å –Ω—É–ª—è]
```

### –ü–æ—Å–ª–µ (—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º):
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ù–µ –º–Ω–æ–≥–æ–≤–∞—Ç–æ –ª–∏ —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤ 317 –≥—Ä–∞–º–º –≤ —Å—É—Ç–∫–∏?
–ë–æ—Ç: –í—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤—ã! 317–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–Ω–æ–≥–æ –¥–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è. 
–î–∞–≤–∞–π—Ç–µ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤–∞—à–∏ —Ü–µ–ª–∏ –¥–æ 200-250–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤ –≤ –¥–µ–Ω—å...
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

–ö–æ–Ω—Ç–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏:
- –ó–∞–ø—Ä–æ—Å–∞—Ö –Ω–∞ —Å–æ–≤–µ—Ç—ã (`getSmartAdvice`)
- –ì–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
- –¢–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:**
```bash
psql -h [your-supabase-url] -U postgres -d postgres -f migrations/add_conversation_context.sql
```

2. **–î–µ–ø–ª–æ–π Edge Function:**
```bash
supabase functions deploy telegram-webhook
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
2. **–û—á–∏—Å—Ç–∫–∞**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/clear` –µ—Å–ª–∏ –¥–∏–∞–ª–æ–≥ –∑–∞—à–µ–ª –≤ —Ç—É–ø–∏–∫
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ä–∞–∑–º–µ—Ä–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- [ ] –°–∂–∞—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
- [ ] –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π/–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π)
- [ ] –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ —Ç–µ–º–∞–º (–ø–∏—Ç–∞–Ω–∏–µ, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —Ü–µ–ª–∏)
- [ ] –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

